<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ELSIE CORP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Cinzel:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --px: 14;            /* snake tile size */
      --trail-steps: 560;  /* long tail so it reads like a frame */
      --band: 16vh;        /* spacing under top band */
      --dice: 76px;        /* dice size */
    }

    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: 'Cormorant Garamond', serif;
      overflow-x: hidden;
      scroll-behavior: smooth;
      overflow-anchor: none;
    }

    /* Push content below the top overlay area */
    body { padding-top: var(--band); }

    /* Background slideshow */
    .background-img {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-height: 70vh;
      max-width: 70vw;
      width: auto;
      height: auto;
      opacity: 0.40;
      pointer-events: none;
      z-index: 0;
      filter: contrast(120%) grayscale(60%) brightness(1.05);
      transition: opacity 180ms linear;
    }
    .black-flicker {
      position: fixed;
      inset: 0;
      background: #000;
      opacity: 0;
      transition: opacity 120ms linear;
      z-index: 6;
      pointer-events: none;
    }

    /* Snake layer (on top of content) */
    #snake-canvas{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 8;     /* above image, below dice/stats */
      pointer-events: none;
      opacity: 1;
    }

    /* LEFT: Dice (two) */
    .dice {
      position: fixed;
      top: calc(var(--band) + 2.6rem);
      left: 6vw;
      width: var(--dice);
      height: var(--dice);
      perspective: 900px;
      perspective-origin: 50% 50%;
      z-index: 12;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.45)) drop-shadow(0 0 18px rgba(255,255,255,.18));
    }
    .dice2 { top: calc(var(--band) + 13.3rem); left: 9vw; }

    .dice .gimbal{
      width:100%; height:100%;
      transform-style: preserve-3d;
      transform-origin: 50% 50%;
      transform: rotateX(-10deg) rotateY(24deg) rotateZ(0deg);
      animation: wobble3d 6s ease-in-out infinite;
      will-change: transform;
    }
    @keyframes wobble3d{
      0%   { transform: rotateX(-10deg) rotateY(24deg) rotateZ(0deg); }
      50%  { transform: rotateX(-6deg)  rotateY(28deg) rotateZ(0deg); }
      100% { transform: rotateX(-10deg) rotateY(24deg) rotateZ(0deg); }
    }
    .dice, .dice .cube, .dice .face { transform-style: preserve-3d; }
    .dice .cube{
      position: relative; width: 100%; height: 100%;
      transition: transform 900ms cubic-bezier(.2,.8,.2,1);
      will-change: transform;
      transform: translateZ(0);
      cursor: pointer;
    }
    .dice .face{
      position: absolute; inset: 0;
      display: grid; grid-template: repeat(3,1fr) / repeat(3,1fr); place-items: center;
      background:
        radial-gradient(120% 120% at 30% 25%, rgba(255,255,255,.92), rgba(235,235,235,.9) 60%, rgba(215,215,215,.85) 100%);
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow:
        inset 0 0 30px rgba(255,255,255,0.35),
        inset 0 0 8px rgba(0,0,0,0.15);
      backface-visibility: hidden;
      transform: translateZ(0);
    }
    .dice .pip{
      width: calc(var(--dice) * 0.16);
      height: calc(var(--dice) * 0.16);
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #000 0 45%, #333 46% 100%);
      box-shadow: 0 1px 0 rgba(255,255,255,.3), inset 0 1px 2px rgba(255,255,255,.25);
    }
    .dice .f1 { transform: translateZ(calc(var(--dice)/2)); }
    .dice .f2 { transform: rotateY(180deg) translateZ(calc(var(--dice)/2)); }
    .dice .f3 { transform: rotateY(90deg) translateZ(calc(var(--dice)/2)); }
    .dice .f4 { transform: rotateY(-90deg) translateZ(calc(var(--dice)/2)); }
    .dice .f5 { transform: rotateX(90deg) translateZ(calc(var(--dice)/2)); }
    .dice .f6 { transform: rotateX(-90deg) translateZ(calc(var(--dice)/2)); }

    /* RIGHT: Stats */
    .stats{
      position: fixed;
      right: 6vw;
      top: calc(var(--band) - 0.4rem);
      text-align: right;
      z-index: 14;
      user-select: none;
    }
    .stats .label{
      font-family: Helvetica, Arial, sans-serif;
      font-weight: 800;
      letter-spacing: .14em;
      font-size: .92rem;
      opacity: .9;
    }
    .stats .basket-line{
      margin-top: .4rem;
      font-family: Helvetica, Arial, sans-serif;
      letter-spacing: .14em;
      font-weight: 800;
      font-size: 1.0rem;
      opacity: .95;
    }
    .stats .basket-num{
      display: block;
      margin-top: .35rem;
      font-family: 'Cinzel', serif;
      font-weight: 700;
      font-size: clamp(1.3rem, 3.2vw, 2.1rem);
      text-shadow: 0 0 14px rgba(255,255,255,.35), 0 0 26px rgba(255,255,255,.18);
    }

    /* Countdown lower-right (roughly image bottom) */
    .countdown-box{
      position: fixed;
      right: 6vw;
      top: calc(50vh + 30vh); /* ≈ bottom of 70vh image */
      transform: translateY(-50%);
      text-align: right;
      z-index: 14;
      user-select: none;
    }
    .countdown-box .digits{
      font-family: Helvetica, Arial, sans-serif;
      font-weight: 900;
      font-size: clamp(1.8rem, 4.2vw, 2.8rem);
      letter-spacing: .04em;
      text-shadow: 0 0 14px rgba(255,255,255,.35), 0 0 26px rgba(255,255,255,.18);
      /* keep width stable so it doesn't “wiggle” */
      font-variant-numeric: tabular-nums lining-nums;
      -moz-font-feature-settings: "tnum" 1, "lnum" 1;
      -webkit-font-feature-settings: "tnum" 1, "lnum" 1;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    /* One-off effects ONLY when a double happens */
    .match-bounce { animation: matchBounce .25s ease-out; }
    @keyframes matchBounce {
      0%   { transform: translateY(0) scale(1); }
      40%  { transform: translateY(-1px) scale(1.03); }
      100% { transform: translateY(0) scale(1); }
    }
    .match-flash  { animation: matchFlash .45s ease-out; }
    @keyframes matchFlash {
      0%,100% { color: inherit; text-shadow: 0 0 14px rgba(255,255,255,.25), 0 0 24px rgba(255,255,255,.15); }
      20%,60% { color: #ff3b3b; text-shadow: 0 0 18px rgba(255,0,0,.5), 0 0 28px rgba(255,0,0,.3); }
    }

    
    /* RED pair overlay */
.combo-overlay{
  position: fixed; inset: 0;
  background:#c40000;
  display:flex; align-items:center; justify-content:center;
  opacity:0;
  visibility:hidden;                /* ← hide when not shown */
  transition: opacity .08s linear,  /* fade */
              visibility 0s linear .08s; /* hide after fade completes */
  z-index:10000;
  pointer-events:none;
}
.combo-overlay.show{
  opacity:1;
  visibility:visible;               /* ← show immediately */
  transition: opacity .08s linear;  /* no visibility delay on show */
}

    
    .combo-overlay .big{
      font-family: Helvetica, Arial, sans-serif;
      font-weight: 900;
      font-size: clamp(6rem, 22vw, 28rem);
      color: #fff;
      letter-spacing: .08em;
      text-shadow: 0 0 24px rgba(255,255,255,.35);
    }

    .white-flash{
  position: fixed; inset: 0;
  background:#fff;
  opacity:0;
  transition: opacity .06s linear;
  z-index:10002;           /* above red pair and milestone */
  pointer-events:none;
}
.white-flash.show{ opacity:1; }


    /* ===== MILESTONES ===== */
.milestone{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:#0aa84f;      /* ← solid (no alpha) for green variants */
  opacity:0; visibility:hidden;
  transition:opacity .14s ease;
  z-index:10001;           /* above red pair */
  pointer-events:none;
  isolation:isolate;       /* avoid blending with layers below */
  mix-blend-mode:normal;   /* ensure normal compositing */
}
.milestone.show{ opacity:1; visibility:visible; }


.milestone .inner{
  text-align: center;
  color: #fff;
  line-height: 1.1;
  white-space: pre-line;                 /* honor \n in text */
  font-family: Helvetica, Arial, sans-serif;
  text-transform: none;
  text-shadow: 0 0 18px rgba(255,255,255,.25);
  padding: 4vmin 6vmin;
}
    .milestone.red   { background:#d30000; }
.milestone.green { background:#0aa84f; }
.milestone.black { background:#000000; }

/* size presets */
.ms-huge   { font-weight: 900; font-size: clamp(3.4rem, 12vw, 12rem); }
.ms-big    { font-weight: 900; font-size: clamp(2.6rem, 10vw, 10rem); }
.ms-medium { font-weight: 800; font-size: clamp(1.4rem, 4vw, 3rem); }
.ms-small  { font-weight: 600; font-size: clamp(0.95rem, 2.2vw, 1.3rem); line-height: 1.35; }

/* modifiers */
.ms-italic    { font-style: italic; }
.ms-lowercase { text-transform: lowercase; }


    /* Label (center) */
    .switcher {
      position: fixed;
      top: calc(var(--band) + 1.0rem);
      left: 50%;
      transform: translateX(-50%);
      font-family: Helvetica, Arial, sans-serif;
      font-weight: 800;
      font-size: 2.3rem;
      z-index: 10;
      display: flex; gap: 1rem;
      text-align: left;
      transition: opacity .25s ease;
      pointer-events: none;
    }
    .switcher.is-hidden { opacity: 0; }
    .planned-word { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.05; }
    .anti-word { visibility: hidden; font-size: 3.2rem; opacity: 0; color: white; transition: opacity .3s, color .3s; }
    .anti-word.visible-white { visibility: visible; opacity: 1; color: white; }
    .anti-word.visible-red   { visibility: visible; opacity: 1; color: red; }

    /* Hero + content */
    .hero { min-height: calc(100vh - var(--band)); display: grid; place-items: center; position: relative; z-index: 3; }
    .hero-inner { display: grid; place-items: center; }
    .text-flicker { font-family: 'Cinzel', serif; font-size: 5rem; text-align: center; animation: flicker 1s infinite; text-shadow: 0 0 10px white, 0 0 20px white; }
    @keyframes flicker { 0%,19%,21%,23%,25%,54%,56%,100%{opacity:1} 20%,24%,55%{opacity:.4} }
    #enter-btn { margin-top: 2rem; font: inherit; font-size: 1.2rem; background: none; color: #fff; border: 1px solid #fff; padding: .5rem 1.5rem; cursor: pointer; }
    #enter-btn:hover { background: #fff; color: #000; }

    .content { font-size: 1.7rem; min-height: 100vh; display: flex; justify-content: center; align-items: center; z-index: 2; position: relative; opacity: 0; transform: translateY(50px); transition: all 1.2s ease; padding: 0 10vw; text-align: left; background: #000; }
    .content.visible { opacity: 1; transform: translateY(0); }
    /* replace your current rules with these */
.text-block {
  position: relative;          /* ← add this */
  max-width: 640px;
  margin: 0 auto;
}

.text-block p {
  margin: 0 0 1rem 0;
  line-height: 1.5;
}


    /* JOIN badge under text section (appears briefly on doubles, random) */
    .join-badge{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: calc(100% + 1rem);  /* 1rem below the end of .text-block */
  padding: .3rem 1.2rem;
  border: 1px solid #fff;
  font-family: 'Cinzel', serif;
  letter-spacing: .08em;
  opacity: 0;
  transition: opacity .18s ease;
  pointer-events: none;
}
.join-badge.show{ opacity: 1; }

   
/* ===== PHONE LAYOUT (≤ 820px) ===== */
@media (max-width: 820px){

  :root{ --band: 12vh; --dice: 84px; } /* tighter band + phone dice size */

  /* keep the image sizing you liked */
  .background-img{ max-width: 92vw; max-height: 78vh; }

  /* --- Top typography --- */
  /* ELSIE CORP. — one line, centered, bigger */
  .text-flicker{
    position: fixed;
    top: calc(env(safe-area-inset-top, 0) + 0.6rem);
    left: 50%;
    transform: translateX(-50%);
    width: 92vw;
    text-align: center;
    white-space: nowrap;
    font-size: clamp(2.4rem, 9.6vw, 3.4rem);
    z-index: 9;
  }

  /* ANTI- PLANNED ECONOMY — one line under it, same size */
  .switcher{
    position: fixed;
    top: calc(env(safe-area-inset-top, 0) + 3.9rem);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: .55rem;
    white-space: nowrap;
    text-align: center;
    font-size: clamp(1.4rem, 6.6vw, 2.4rem);
    z-index: 9;
  }
  .switcher .anti-word{ font-size: inherit; }   /* ANTI same size */
  .planned-word{
    display: flex;               /* make words sit in one row */
    flex-direction: row;
    gap: .35rem;
    line-height: 1;
  }
  .planned-word .line{ display: inline-block; }

  /* --- Dice: centered as a pair --- */
  .dice{
    top: 44vh;
    left: calc(50% - calc(var(--dice) * 0.9));  /* left cube */
    transform: none;
    z-index: 12;
  }
  .dice2{
    top: 44vh;
    left: calc(50% + calc(var(--dice) * 0.9));  /* right cube */
    transform: none;
    z-index: 12;
  }

  /* --- Bottom metrics (aligned) --- */
  /* Countdown bottom-left */
  .countdown-box{
    left: 6vw; right: auto;
    bottom: 9vh; top: auto;
    transform: none;
    text-align: left;
  }
  .countdown-box .digits{
    font-size: clamp(1.9rem, 8.6vw, 2.6rem);  /* matches basket-num below */
    letter-spacing: .02em;
  }

  /* Basket bottom-right (label above, number aligned to countdown) */
  .stats{
    right: 6vw; left: auto;
    bottom: 9vh; top: auto;
    text-align: right;
  }
  .stats .label{ font-size: .95rem; }
  .stats .basket-line{ font-size: 1.05rem; margin-top: .2rem; }
  .stats .basket-num{
    display: block;              /* number on its own line */
    margin-top: .25rem;
    line-height: 1;
    font-size: clamp(1.9rem, 8.6vw, 2.6rem); /* same as countdown */
  }

  /* Text width + JOIN chip positioning on phones */
  .text-block{ position: relative; max-width: 86vw; margin: 0 auto; }
  .join-badge{ position: static; display: inline-block; margin-top: 1.2rem; transform: none; }

  /* If the snake causes layering/perf on phones, keep it off */
  #snake-canvas{ display: none !important; }
}


    
  </style>
</head>
<body>
  <!-- Background slideshow -->
  <img src="images.jpeg" alt="Background" class="background-img" id="bg-img">
  <div class="black-flicker" id="black-fx"></div>

  <!-- Snake layer -->
  <canvas id="snake-canvas"></canvas>

  <!-- LEFT: DICE (two) -->
  <div class="dice dice1">
    <div class="gimbal">
      <div class="cube" id="cube1">
        <div class="face f1"><span class="pip" style="grid-area:2/2;"></span></div>
        <div class="face f2"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f3"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:2/2;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f4"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:1/3;"></span><span class="pip" style="grid-area:3/1;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f5"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:1/3;"></span><span class="pip" style="grid-area:2/2;"></span><span class="pip" style="grid-area:3/1;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f6"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:2/1;"></span><span class="pip" style="grid-area:3/1;"></span><span class="pip" style="grid-area:1/3;"></span><span class="pip" style="grid-area:2/3;"></span><span class="pip" style="grid-area:3/3;"></span></div>
      </div>
    </div>
  </div>

  <div class="dice dice2">
    <div class="gimbal">
      <div class="cube" id="cube2">
        <div class="face f1"><span class="pip" style="grid-area:2/2;"></span></div>
        <div class="face f2"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f3"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:2/2;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f4"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:1/3;"></span><span class="pip" style="grid-area:3/1;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f5"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:1/3;"></span><span class="pip" style="grid-area:2/2;"></span><span class="pip" style="grid-area:3/1;"></span><span class="pip" style="grid-area:3/3;"></span></div>
        <div class="face f6"><span class="pip" style="grid-area:1/1;"></span><span class="pip" style="grid-area:2/1;"></span><span class="pip" style="grid-area:3/1;"></span><span class="pip" style="grid-area:1/3;"></span><span class="pip" style="grid-area:2/3;"></span><span class="pip" style="grid-area:3/3;"></span></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: Stats (top-right) -->
  <aside class="stats">
    <div class="label">PERFUMES</div>
    <div class="basket-line">IN YOUR BASKET:</div>
    <span id="basket-num" class="basket-num">0</span>
  </aside>

  <!-- RIGHT: Countdown (lower-right) -->
  <aside class="countdown-box">
    <div id="countdown" class="digits">00:00:00</div>
  </aside>

  <!-- Red combo overlay -->
  <div class="combo-overlay" id="combo-overlay">
    <div class="big" id="combo-text"></div>
  </div>

  <div id="white-flash" class="white-flash"></div>
  
  <!-- Milestone overlay (big messages on color backgrounds) -->
<div id="milestone" class="milestone">
  <div id="milestone-inner" class="inner ms-big"></div>
</div>


  <!-- Center label -->
  <div class="switcher" id="switcher">
    <span class="anti-word" id="anti-text">ANTI-</span>
    <div class="planned-word">
      <span class="line">PLANNED</span>
      <span class="line">ECONOMY</span>
    </div>
  </div>

  <!-- Hero -->
  <section class="hero">
    <div class="hero-inner">
      <div class="text-flicker" id="title">ELSIE CORP.</div>
      <button id="enter-btn">ENTER</button>
    </div>
  </section>

  <!-- Content -->
  <section class="content" id="reveal">
    <div class="text-block">
      <p><strong>ELSIE CORP</strong> is a perfume salon.</p>
      <p>We work with artists, theorists, funders, and institutions to shape forces, not products.</p>
      <p>Our primary goal is consensual abductive teamwork. Here, we are teaching a course on hyperadaptive identities.</p>
      <div id="join-badge" class="join-badge">JOIN</div>
    </div>
  </section>

  <script>
    /* Start at top */
    try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch(e){}
    window.addEventListener('load', () => window.scrollTo(0, 0));

    /* UI: ENTER + reveal */
    const enterBtn  = document.getElementById('enter-btn');
    const title     = document.getElementById('title');
    const reveal    = document.getElementById('reveal');
    const antiText  = document.getElementById('anti-text');
    const switcher  = document.getElementById('switcher');

    enterBtn.addEventListener('click', () => {
      title.style.animation = 'none';
      title.style.opacity = '1';
      enterBtn.style.display = 'none';
      switcher.classList.add('is-hidden');
      window.scrollTo({ top: reveal.offsetTop, behavior: 'smooth' });
    });

    window.addEventListener('scroll', () => {
      const rect = reveal.getBoundingClientRect();
      if (rect.top < window.innerHeight) {
        reveal.classList.add('visible');
        switcher.classList.add('is-hidden');
        contentVisible = true;     
      }
    });

    function complexFlickerAnti() {
      antiText.className = 'anti-word visible-white';
      setTimeout(() => {
        antiText.className = 'anti-word';
        setTimeout(() => {
          antiText.className = 'anti-word visible-red';
          setTimeout(() => {
            antiText.className = 'anti-word';
            setTimeout(() => {
              antiText.className = 'anti-word visible-white';
              setTimeout(() => { antiText.className = 'anti-word'; }, 200);
            }, 200);
          }, 120);
        }, 120);
      }, 120);
    }
    (function loopAntiFlicker() {
      const interval = Math.floor(Math.random() * 10000) + 5000;
      setTimeout(() => { complexFlickerAnti(); loopAntiFlicker(); }, interval);
    })();

    /* ---------- Slideshow (4s) ---------- */
    const BG = document.getElementById('bg-img');
    const FX = document.getElementById('black-fx');

    const IMAGES = [
      'images.jpeg',
      '01.png','02.png','02.jpg','03.png','03.jpg',
      '04.jpg','05.jpg','06.jpg','07.jpg','08.jpg',
      '09.jpg','010.jpg','011.jpg','012.jpg','013.jpg'
    ];
    IMAGES.forEach(src => { const i = new Image(); i.src = src; });

    const SHOW_MS = 4000, FLICK_MS = 120;
    let idx = 1;

    /* ---------- Dice ---------- */
    const cube1 = document.getElementById('cube1');
    const cube2 = document.getElementById('cube2');

    const POSES = [
      'rotateX(0deg) rotateY(0deg)',       // 1
      'rotateX(0deg) rotateY(180deg)',     // 2
      'rotateX(0deg) rotateY(-90deg)',     // 3
      'rotateX(0deg) rotateY(90deg)',      // 4
      'rotateX(-90deg) rotateY(0deg)',     // 5
      'rotateX(90deg) rotateY(0deg)'       // 6
    ];

    let faces = [0, 0];
    function setFace(c, idx){ c.style.transform = POSES[idx]; }
    function rollDie(i, c){
      let n; do { n = (Math.random() * 6) | 0; } while (n === faces[i]);
      faces[i] = n; setFace(c, n);
    }
    setFace(cube1, faces[0]); setFace(cube2, faces[1]);

    /* ---------- Stats (basket + countdown) ---------- */
    const basketEl    = document.getElementById('basket-num');
    const countdownEl = document.getElementById('countdown');
    const joinBadge   = document.getElementById('join-badge');

    
let rollCount = 0;
let contentVisible = false; // only show JOIN when text screen is visible

    function flashOnce(el){
      el.classList.remove('match-flash','match-bounce');
      void el.offsetWidth; // reflow
      el.classList.add('match-flash','match-bounce');
      setTimeout(() => el.classList.remove('match-flash','match-bounce'), 500);
    }

    let basket = 0;
    let cdTarget = new Date(Date.now() + 3600 * 1000);

    function setRandomCountdown(){
      const hrs = Math.floor(Math.random()*7) + 1;     // 1..7 hours
      const mins = Math.floor(Math.random()*60);
      const secs = Math.floor(Math.random()*50)+10;    // 10..59
      cdTarget = new Date(Date.now() + (hrs*3600 + mins*60 + secs)*1000);
      countdownEl.textContent = [hrs,mins,secs].map(v=>String(v).padStart(2,'0')).join(':');
    }
    function tickCountdown(){
      const now = new Date();
      let diff = Math.max(0, Math.floor((cdTarget - now)/1000));
      const h = String(Math.floor(diff/3600)).padStart(2,'0');
      diff %= 3600;
      const m = String(Math.floor(diff/60)).padStart(2,'0');
      const s = String(diff%60).padStart(2,'0');
      countdownEl.textContent = `${h}:${m}:${s}`;
    }
    setInterval(tickCountdown, 1000);
    setRandomCountdown();

    
function flashOverlay(val, showMs = 260){
  const overlay = document.getElementById('combo-overlay');
  const text = document.getElementById('combo-text');
  return new Promise(resolve => {
    text.textContent = `${val}   ${val}`;
    overlay.classList.add('show');
    setTimeout(() => {
      const onEnd = (e) => {
        if (e.propertyName === 'opacity') {
          overlay.removeEventListener('transitionend', onEnd);
          resolve();
        }
      };
      overlay.addEventListener('transitionend', onEnd, { once:true });
      overlay.classList.remove('show');   // start fade-out
    }, showMs);
  });
}
    function whiteFlash(ms = 70){
  const wf = document.getElementById('white-flash');
  if (!wf) return Promise.resolve();  // fail-safe
  return new Promise(resolve => {
    wf.classList.add('show');
    setTimeout(() => {
      wf.classList.remove('show');
      setTimeout(resolve, 80); // let the CSS transition finish
    }, ms);
  });
}



    
 /* ===== MILESTONE MESSAGES ===== */
  const milestoneEl = document.getElementById('milestone');
  const milestoneInner = document.getElementById('milestone-inner');

  const MILESTONES = {
    5:  { bg:'#0d8f4a', text:'WAGMI',                         cls:'ms-huge',                 dur:1400 },
    10: { bg:'#c40000', text:'ily\nsometimes',                cls:'ms-huge ms-lowercase',    dur:1500 },
    15: { bg:'#000000', text:'WAGMI\nWAGMI\nWAGMI',           cls:'ms-huge',                 dur:1400 },
    20: { bg:'#c40000', text:'its was all planned\nTHANK YOU FOR PLAYING', cls:'ms-big',    dur:1800 },
    25: { bg:'#0d8f4a', text:`I'm thinking of art as an inversion of apocalypse, art as an inversion of revelation, art as obscuration of, not necessarily truth, maybe that's the thing, because Heidegger is talking about, what is his term that he is using, coming into being, what is his term, but he basically resorts to pre-socraticism, this process of revealing, revealing, yeah, he's talking about revealing via technology, and it's apocalyptic also, he's like also an apocalyptic thinker, Hegelian is also an apocalyptic thinker, but I'm thinking, yeah, like in some parts, art still needs this revelation, because there is things to reveal still, there are things to learn from, but art bubble definitely does not need any revelation, they need something else, but global, like a more globalized, like Normie, you know, Normies need revelation, art hosts don't need revelation, so there should be like a systematic overview of like strategic tasking for a contemporary artist, which is taking into consideration the complex, layered environments that, where some of them require apocalypse, and some of them don't.`,
         cls:'ms-small', dur:6500 },
    30: { bg:'#c40000', text:'They made all the roses transparent. Toss a coin! They put on soundcloud mysticism. They were imposing “DJ BERKLEY” upon us. Toss a coin! GO ON',
         cls:'ms-medium', dur:3200 },
    35: { bg:'#c40000', text:'GO ON',                        cls:'ms-huge',                 dur:1500 },
    40: { bg:'#0d8f4a', text:'A LITTLE MORE',                cls:'ms-huge',                 dur:1500 },
    50: { bg:'#c40000', text:'Redistribution of the..\nsensible-financial',
         cls:'ms-big ms-italic',                              dur:2000 },
    60: { bg:'#7a0000', text:'secret',                        cls:'ms-huge',                 dur:1600 },
    70: { bg:'#000000', text:'sorry. forgive me. forgive me', cls:'ms-big ms-lowercase',     dur:2000 },
  };

  function showMilestone(n){
  const milestoneEl = document.getElementById('milestone');
  const milestoneInner = document.getElementById('milestone-inner');
  const ms = MILESTONES?.[n];     // your milestones map from earlier
  return new Promise(resolve => {
    if (!ms) return resolve();
    milestoneEl.style.background = ms.bg;  // solid color (no alpha)
    milestoneInner.className = 'inner ' + ms.cls;
    milestoneInner.textContent = ms.text;
    milestoneEl.classList.add('show');
    setTimeout(() => {
      milestoneEl.classList.remove('show');
      resolve();
    }, ms.dur || 1600);
  });
}
async function onDouble(val){
  // bump basket + tiny reactions (use your existing helpers/vars)
  basket += 1;
  basketEl.textContent = String(basket);
  flashOnce(basketEl);
  flashOnce(countdownEl);
  setRandomCountdown();

  // sequence: red pair -> white flash -> milestone
  await flashOverlay(val, 260);
  await whiteFlash(70);
  await showMilestone(basket);

  // optional: your join blip
  maybeShowJoin();
}

function pulseJoin(){
  if (!contentVisible) return;
  joinBadge.classList.add('show');
  setTimeout(() => joinBadge.classList.remove('show'), 1000);
}
    
    function rollBothAndMaybeFlash(){
  rollCount++;
  rollDie(0, cube1);
  setTimeout(() => {
    rollDie(1, cube2);
    if (faces[0] === faces[1]) {
      const val = faces[0] + 1;
      onDouble(val);
    }
    if (rollCount % 2 === 0) pulseJoin();  // ← every second roll
  }, 0);
}


    // roll when image changes (every 4s)
    setInterval(() => {
      FX.style.opacity = '1';
      setTimeout(() => {
        BG.src = IMAGES[idx % IMAGES.length];
        idx++;
        rollBothAndMaybeFlash();
        FX.style.opacity = '0';
      }, FLICK_MS);
    }, SHOW_MS);

    // clicking a die also rolls & makes snake gravitate
    document.querySelectorAll('.cube').forEach(c => c.addEventListener('click', () => {
      rollBothAndMaybeFlash();
      mode = 'grav'; gravStrength = 0;
    }));

    /* ===================== SNAKE ===================== */
    const cvs = document.getElementById('snake-canvas');
    const ctx = cvs.getContext('2d');

    function resizeCanvas() {
      cvs.width  = window.innerWidth;
      cvs.height = window.innerHeight;
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      computeFrame();
    }
    window.addEventListener('resize', resizeCanvas);
    BG.addEventListener('load', computeFrame);
    resizeCanvas();

    const TILE  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--px'), 10);
    const TAIL  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--trail-steps'), 10);
    const MARGIN_FRAME = TILE * 2.2;

    let frame = { left: 80, top: 80, right: window.innerWidth-80, bottom: window.innerHeight-80 };
    function snap(v){ return Math.round(v / TILE) * TILE; }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function computeFrame(){
      const r = BG.getBoundingClientRect();
      let L = r.left   - MARGIN_FRAME;
      let T = r.top    - MARGIN_FRAME;
      let R = r.right  + MARGIN_FRAME;
      let B = r.bottom + MARGIN_FRAME;

      const tooSmall = (R - L) < TILE*12 || (B - T) < TILE*12 || !isFinite(L);
      if (tooSmall) {
        const vw = innerWidth, vh = innerHeight;
        const s  = Math.round(0.70 * Math.min(vw, vh));
        const L0 = Math.round((vw - s) / 2);
        const T0 = Math.round((vh - s) / 2);
        L = L0 - MARGIN_FRAME; T = T0 - MARGIN_FRAME; R = L0 + s + MARGIN_FRAME; B = T0 + s + MARGIN_FRAME;
      }

      frame.left   = snap(clamp(L, 8, innerWidth  - 8));
      frame.top    = snap(clamp(T, 8, innerHeight - 8));
      frame.right  = snap(clamp(R, frame.left+TILE*4, innerWidth  - 8));
      frame.bottom = snap(clamp(B, frame.top +TILE*4, innerHeight - 8));

      if (mode === 'rect') {
        head.x = frame.left;
        head.y = frame.top;
        dir = { x: TILE, y: 0 };
        rectEdge = 0;
      }
    }

    // snake state
    let head = { x: frame.left, y: frame.top };
    let dir  = { x: TILE, y: 0 };
    let trail = [];
    let lastStep = 0;

    let mode = 'rect';           // 'rect' perimeter -> 'grav' (after click)
    let rectEdge = 0;            // 0 top, 1 right, 2 bottom, 3 left
    const RECT_STEP_MS = 56;     // perimeter speed
    const GRAV_STEP_MS = 74;     // gravitate speed
    let gravStrength = 0;
    let target = { x: innerWidth/2, y: innerHeight/2 };
    window.addEventListener('mousemove', e => { target.x = e.clientX; target.y = e.clientY; }, { passive: true });

    function step(now){
      requestAnimationFrame(step);
      const ms = (mode === 'rect') ? RECT_STEP_MS : GRAV_STEP_MS;
      if (now - lastStep < ms) return;
      lastStep = now;

      if (mode === 'rect') {
        let nx = head.x + dir.x, ny = head.y + dir.y;
        if (rectEdge === 0 && nx >= frame.right)      { nx = frame.right;  dir = {x:0, y:TILE};   rectEdge = 1; }
        else if (rectEdge === 1 && ny >= frame.bottom){ ny = frame.bottom; dir = {x:-TILE, y:0}; rectEdge = 2; }
        else if (rectEdge === 2 && nx <= frame.left)  { nx = frame.left;   dir = {x:0, y:-TILE};  rectEdge = 3; }
        else if (rectEdge === 3 && ny <= frame.top)   { ny = frame.top;    dir = {x:TILE, y:0};   rectEdge = 0; }
        head = { x: nx, y: ny };
      } else {
        gravStrength = Math.min(1, gravStrength + 0.06);
        const dx = target.x - head.x, dy = target.y - head.y;
        const preferX = Math.abs(dx) > Math.abs(dy) * (1 - 0.4*gravStrength);
        if (preferX && Math.abs(dx) > TILE/2)      dir = { x: Math.sign(dx)*TILE, y: 0 };
        else if (Math.abs(dy) > TILE/2)            dir = { x: 0, y: Math.sign(dy)*TILE };
        else                                       dir = { x: 0, y: 0 };
        head = {
          x: clamp(head.x + dir.x, TILE/2, innerWidth  - TILE/2),
          y: clamp(head.y + dir.y, TILE/2, innerHeight - TILE/2)
        };
      }

      trail.unshift({ x: head.x, y: head.y });
      if (trail.length > TAIL) trail.pop();

      // draw
      ctx.clearRect(0, 0, cvs.width, cvs.height);

      // glow
      ctx.shadowColor = 'rgba(255,255,255,1)';
      ctx.shadowBlur = 26;

      // head
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(head.x, head.y, TILE * 0.9, 0, Math.PI * 2);
      ctx.fill();

      // body squares with fade (grid-snapped)
      for (let i = 1; i < trail.length; i++) {
        const t = i / trail.length;
        const alpha = Math.max(0, 1 - t * 1.05);
        if (alpha <= 0) continue;

        ctx.globalAlpha = alpha;
        const gx = Math.round(trail[i].x / TILE) * TILE;
        const gy = Math.round(trail[i].y / TILE) * TILE;

        ctx.fillStyle = '#fff';
        ctx.fillRect(gx - TILE/2, gy - TILE/2, TILE, TILE);

        ctx.globalAlpha = alpha * 0.35;
        const p = TILE / 4;
        ctx.fillRect(gx - TILE/2 + p, gy - TILE/2 + p, TILE - 2*p, TILE - 2*p);
      }
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
    }

    function primeTrail(len = 28){
      trail.length = 0;
      for (let i = 0; i < len; i++){
        trail.unshift({ x: frame.left - i*TILE, y: frame.top });
      }
    }

    requestAnimationFrame(step);
    computeFrame();
    primeTrail();

  </script>
</body>
</html>
